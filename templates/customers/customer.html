{% extends "site.html" %}

<!-- Title -->
{% block title %}
    Kunde "{{customer.name}}"
{% endblock title %}

<!-- Content-->
{% block content %}
    <div class="content">
        {% if request.user.is_authenticated %}
            {% if message %}
                {% if status == 'False' %}
                    <div class="alert alert-danger" role="alert">
                        {{message}}
                    </div>
                {% else %}
                    <div class="alert alert-success" role="alert">
                        {{message}}
                    </div>
                {% endif %}
            {% endif %}
            <h1>Kunde "{{customer.name}}" - K.Nr.: {{customer.customer_number}}</h1><hr>
            <div class="center">
                <a href="{% url 'locations_create' customer_id=customer.id %}">
                    <button type="button" class="btn btn-primary">
                        + Standort hinzufügen
                    </button>
                </a>
                <a href="{% url 'customers_edit' id=customer.id %}">
                    <button type="button" class="btn btn-default">
                        <i class="fas fa-edit"></i>
                    </button>
                </a>
                <a href="{% url 'customers_delete' id=customer.id %}">
                    <button type="button" class="btn btn-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </a>
            </div><br>
            <div class="container">
                <div class="accordion col" id="accordionExample">
                    <div class="card row-md-2">
                        {% for location in locations %}
                            <div class="card-header" id="headingOne">
                                <h2 class="mb-0">
                                    <button class="btn btn-link btn-block text-left"
                                        type="button"
                                        data-toggle="collapse"
                                        data-target="#collapse-{{location.id}}"
                                        aria-expanded="true"
                                        aria-controls="collapse-{{location.id}}"
                                    >
                                        {{location.name}}
                                    </button>
                                </h2>
                            </div>
                            <div id="collapse-{{location.id}}" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
                                <div class="card-body">
                                    <table class="table">
                                        <tbody>
                                            <tr>
                                                <th scope="row"><b>Ansprechpartner</b></th>
                                                {% for person in location.persons %}
                                                    <td>{{person.first_name}} {{person.last_name}}</td>
                                                {% endfor %}
                                            </tr>
                                            <tr>
                                                <th scope="row"><b>Anschrift</b></th>
                                                <td>{{location.name}}</td>
                                                <td>{{location.street}}</td>
                                                <td>{{location.house_number}}</td>
                                                <td>{{location.postcode}}</td>
                                                <td>{{location.city}}</td>
                                                <td>{{location.phone_number}}</td>
                                                <td>{{location.email_address}}</td>
                                            </tr>
                                            <tr>
                                                <td class="location-button">
                                                    <a href="{% url 'locations_edit' customer_id=customer.id id=location.id %}">
                                                        <button type="button" class="btn btn-sm btn-default">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteLocation({{ location.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <script>
                /**
                 * Deletes the location with the given id by sending an ajax request.
                 * After that you get a success or error message.
                 * 
                 * @param {int} id  location id
                 */
                deleteLocation = (id) => {
                    $.ajax({
                        type : "POST", 
                        url  : "{% url 'locations_delete' %}",
                        data : {
                            id                  : id,
                            csrfmiddlewaretoken : '{{ csrf_token }}',
                            dataType            : "json",
                        },
                        success: (result) => {
                            if (result.status) {
                                document.location.href = "{% if customer.id %}{% url 'customer' id=customer.id %}{% else %}{% url 'customers_list' %}{% endif %}";
                            } else {
                                $('#alert').removeClass('hidden-alert');
                                $('#alert').html(result.message);
                            }
                        },
                        failure: () => {
                            console.log('Request failed!');
                        },
                    });
                };
            </script>
        {% else %}
            <h1>Sie müssen sich erst anmelden.</h1>
            <button type="button">
                <a href="{% url 'login' %}">Anmelden</a>
            </button>
        {% endif %}
    </div>
{% endblock content %}
