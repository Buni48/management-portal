{% extends "site.html" %}

<!-- Title -->
{% block title %}
    Suche
{% endblock title %}

{% block content %}
    <div class="content">
        {% if request.user.is_authenticated %}
            <h1>Globale Suche</h1>

            <form id="form" class="form-inline mr-auto mb-4">
                <input class="form-control mr-sm-2 input-search"
                    id="search_word"
                    type="text"
                    placeholder="Suchbegriff eingeben"
                    aria-label="Search"
                    min="3"
                    max="64"
                >
                <button class="btn btn-indigo btn-rounded btn-sm my-0 waves-effect waves-light" type="submit">
                    Suche
                </button>
            </form>

            <div id="customers">
                <h2 id="customer-title" class="hidden">Kunden</h2>
               <table id="customer-table selectedColumn" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
                </table>
            </div>

            <script>
                $('#form').on('submit', (event) => {
                    event.preventDefault();
            
                    $.ajax({
                        type : "POST", 
                        url  : "{% url 'search_result' %}",
                        data : {
                            search_word         : $('#search_word').val(),
                            csrfmiddlewaretoken : '{{ csrf_token }}',
                            dataType            : "json",
                        },
                        success: (result) => {
                            console.log(result);
                            if (!Object.entries(result).length) {
                                /* @todo prevent this or show error message */
                                return;
                            }
                            if (result.customers == '[]') {
                                customers = null;
                            } else {
                                customers = JSON.parse(result.customers);
                            }
                            
                            let customerThead = document.getElementById('customer-thead');
                            if (customers) {
                                document.getElementById('customer-title').classList.remove('hidden');
                                let customerTable = document.getElementById('customer-table selectedColumn');
                                let data          = Object.keys(customers[0]);
                                if (!customerThead) {
                                    generateTableHead(customerTable, data, 'customer');
                                } else {
                                    deleteTable('customer');
                                }
                                generateTableBody(customerTable, customers, 'customer');
                            } else {
                                document.getElementById('customer-title').classList.add('hidden');
                                if (customerThead) {
                                    deleteTable('customer', customerThead);
                                }
                            }
                        },
                        failure: () => {
                            console.log('error');
                        }
                    });
                });

                generateTableHead = (table, data, name) => {
                    let thead = table.createTHead();
                    thead.setAttribute('id', name + '-thead');
                    let row = thead.insertRow();
                    for (let key of data) {
                        if (key == 'id') {
                            continue;
                        }
                        let th = document.createElement('th');
                        th.classList.add('th-sm');
                        let text = document.createTextNode(parseKey(key));
                        th.appendChild(text);
                        row.appendChild(th);
                    }
                };

                generateTableBody = (table, data, name) => {
                    let tbody = table.createTBody();
                    tbody.setAttribute('id', name + '-tbody');
                    for (let element of data) {
                        let row = tbody.insertRow();
                        for (key in element) {
                            if (key == 'id') {
                                continue;
                            }
                            let cell = row.insertCell();
                            let text = document.createTextNode(element[key]);
                            cell.appendChild(text);
                        }
                    }
                };

                deleteTable = (name, thead = null) => {
                    let tbody = document.getElementById(name + '-tbody');
                    tbody.remove();
                    if (thead) {
                        thead.remove();
                    }
                };

                parseKey = (key) => {
                    if (typeof key !== 'string') {
                        return '';
                    }
                    key = key.charAt(0).toUpperCase() + key.slice(1);
                    key = key.replace('_', ' ');
                    return key;
                };
            </script>

        {% else %}
            <h1>Sie m√ºssen sich erst anmelden.</h1>
            <button type="button">
                <a href="{% url 'login' %}">Anmelden</a>
            </button>

        {% endif %}
    </div>
{% endblock content %}

{% block custom_js}

{% endblock custom_js}
